{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç: {{ display_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-lg border-0 chat-card">
        <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
        <div class="card-header chat-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-comments fa-2x me-3"></i>
                <div>
                    <h5 class="mb-0">{{ display_name }}</h5>
                    <small class="opacity-75">
                        <i class="fas fa-circle text-success me-1" style="font-size: 0.6rem;"></i>
                        –û–Ω–ª–∞–π–Ω
                    </small>
                </div>
            </div>
            <a href="{% url 'blog:home' %}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>–ù–∞–∑–∞–¥
            </a>
        </div>

        <div class="card-body chat-body">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="chat-search">
                <form method="get" action="{% url 'blog:chat_room' room_name %}">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" name="q" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º..." value="{{ search_query }}">
                        <button class="btn btn-primary" type="submit">–ù–∞–π—Ç–∏</button>
                    </div>
                </form>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages" id="chat-messages" 
                 data-room-name="{{ room_name }}"
                 data-current-username="{{ user.username }}">

                <!-- –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ë–î -->
                <div id="history-messages">
                    {% for message in messages %}
                    <div class="message-wrapper {% if message.user.username == user.username %}own{% else %}other{% endif %}">
                        <div class="message-bubble">
                            <span class="message-username">{{ message.user.username }}</span>
                            <p class="message-text">{{ message.content }}</p>
                            <small class="message-time">{{ message.created_at|date:"H:i" }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5" id="empty-placeholder">
                        <i class="fas fa-comments fa-3x mb-3 opacity-25"></i>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket -->
                <div id="new-messages"></div>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if messages.has_other_pages %}
            <nav class="chat-pagination">
                <ul class="pagination pagination-sm justify-content-center">
                    {% if messages.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ messages.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in messages.paginator.page_range %}
                        {% if page_num == messages.number|add:-2 or page_num == messages.number|add:-1 or page_num == messages.number or page_num == messages.number|add:1 or page_num == messages.number|add:2 %}
                            <li class="page-item {% if messages.number == page_num %}active{% endif %}">
                                <a class="page-link" href="?page={{ page_num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ page_num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if messages.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ messages.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ messages.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
            <div class="chat-input">
                <!-- –ü–∞–Ω–µ–ª—å —Å–º–∞–π–ª–∏–∫–æ–≤ -->
                <div id="emojiPicker" class="emoji-picker">
                    <div id="emojiGrid" class="emoji-grid"></div>
                </div>

                <div class="input-group">
                    <button type="button" id="emojiButton" class="btn btn-emoji" title="–°–º–∞–π–ª–∏–∫–∏">
                        <i class="far fa-smile"></i>
                    </button>
                    <input type="text" class="form-control" id="messageInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" maxlength="1000">
                    <button class="btn btn-primary btn-send" id="sendButton">
                        <i class="fas fa-paper-plane me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const roomName = document.getElementById('chat-messages').dataset.roomName;
    const currentUsername = document.getElementById('chat-messages').dataset.currentUsername;

    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
        window.location.host +
        '/ws/chat/' + roomName + '/'
    );

    const messagesContainer = document.getElementById('chat-messages');
    const newMessagesContainer = document.getElementById('new-messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const emojiButton = document.getElementById('emojiButton');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');

    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('üì® Message:', data);

        if (data.error) {
            if (data.moderation_blocked) {
                alert('–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: ' + data.error);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
            return;
        }

        const placeholder = document.getElementById('empty-placeholder');
        if (placeholder) placeholder.remove();

        const isOwnMessage = data.username === currentUsername;
        console.log('Own message:', isOwnMessage);

        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${isOwnMessage ? 'own' : 'other'}`;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        const username = document.createElement('span');
        username.className = 'message-username';
        username.textContent = data.username;

        const text = document.createElement('p');
        text.className = 'message-text';
        text.textContent = data.message;

        const time = document.createElement('small');
        time.className = 'message-time';
        time.textContent = data.timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        bubble.appendChild(username);
        bubble.appendChild(text);
        bubble.appendChild(time);
        wrapper.appendChild(bubble);

        newMessagesContainer.appendChild(wrapper);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    chatSocket.onopen = () => console.log('‚úÖ WebSocket connected');
    chatSocket.onclose = () => console.error('‚ùå WebSocket closed');

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({ 'message': message }));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üí™','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','‚≠ê','üåü','‚ú®','‚ö°','üî•','üí•','üí´','üí¶','üí®','üåà','‚òÄÔ∏è','üåô'];

    emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-item';
        btn.textContent = emoji;
        btn.onclick = (e) => {
            e.preventDefault();
            messageInput.value += emoji;
            messageInput.focus();
        };
        emojiGrid.appendChild(btn);
    });

    let isEmojiVisible = false;
    emojiButton.onclick = (e) => {
        e.preventDefault();
        isEmojiVisible = !isEmojiVisible;
        emojiPicker.style.display = isEmojiVisible ? 'block' : 'none';
    };

    document.addEventListener('click', (e) => {
        if (!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)) {
            emojiPicker.style.display = 'none';
            isEmojiVisible = false;
        }
    });
</script>
{% endblock %}
