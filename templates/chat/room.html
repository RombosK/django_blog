{% extends 'base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç: {{ display_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>–ß–∞—Ç: {{ display_name }}</h5>
            <a href="{% url 'blog:home' %}" class="btn btn-sm btn-primary">–ù–∞–∑–∞–¥</a>
        </div>
        <div class="card-body">
            <div
                class="chat-messages"
                id="chat-messages"
                style="height: 400px; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;"
                data-room-name="{{ room_name }}"
            >
                {% for message in messages %}
                <div class="mb-2 p-2 bg-light rounded">
                    <strong>{{ message.user_username }}</strong>
                    <small class="text-muted ms-2">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                    <p class="mb-0 mt-1">{{ message.content }}</p>
                </div>
                {% endfor %}
            </div>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="input-group mb-3 position-relative" style="margin-top: 15px;">
                <input
                    type="text"
                    class="form-control"
                    id="messageInput"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    autocomplete="off"
                    style="padding-right: 50px;"
                >
                <button
                    type="button"
                    id="emojiButton"
                    class="btn position-absolute"
                    style="
                        right: 105px; /* –°–¥–≤–∏–Ω—É—Ç–æ –µ—â–µ –ª–µ–≤–µ–µ –Ω–∞ ~5–º–º (–ø—Ä–∏–º–µ—Ä–Ω–æ 20px) */
                        top: 50%;
                        transform: translateY(-50%);
                        background: transparent;
                        border: none;
                        cursor: pointer;
                        font-size: 18px;
                        padding: 0;
                        z-index: 5;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    "
                    aria-label="–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏"
                >
                    üòä
                </button>
                <button class="btn btn-primary" id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

                <!-- –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä -->
                <div id="emojiPicker" class="border rounded p-2" style="
                    position: absolute;
                    bottom: 100%;
                    right: 0;
                    display: none;
                    width: 300px;
                    max-height: 200px;
                    overflow-y: auto;
                    background: white;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    border-radius: 8px;
                    margin-bottom: 10px;
                    /* –î–ª—è –∫—Ä–æ—Å—Å-–±—Ä–∞—É–∑–µ—Ä–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
                    -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    -moz-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ">
                    <div id="emojiGrid" style="
                        display: -webkit-grid; /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Safari */
                        display: grid;
                        -webkit-grid-template-columns: repeat(10, 1fr); /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Safari */
                        grid-template-columns: repeat(10, 1fr);
                        gap: 6px;
                    "></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === WebSocket ===
    const roomName = document.getElementById('chat-messages').dataset.roomName;
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
        window.location.host +
        '/ws/chat/' + roomName + '/'
    );

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const emojiButton = document.getElementById('emojiButton');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageEl = document.createElement('div');
        messageEl.className = 'mb-2 p-2 bg-white rounded border';
        messageEl.innerHTML = `
            <strong>${data.username}</strong>
            <small class="text-muted ms-2">${data.timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</small>
            <p class="mb-0 mt-1">${data.message}</p>
        `;
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket –∑–∞–∫—Ä—ã—Ç');
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                message: message
            }));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // –≠–º–æ–¥–∑–∏
    const emojis = [
        'üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá',
        'üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö',
        'üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©',
        'ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£',
        'üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨',
        'ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó',
        'ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ',
        'üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê',
        'ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëª',
        'üëΩ','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ',
        'üòø','üòæ','üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº'
    ];

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏-—Å–µ—Ç–∫–∏
    emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-sm';
        button.textContent = emoji;
        button.style.fontSize = '20px';
        button.style.padding = '4px';
        button.style.width = '100%';
        button.style.height = '100%';
        // –î–ª—è –∫—Ä–æ—Å—Å-–±—Ä–∞—É–∑–µ—Ä–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        button.style.display = '-webkit-flex'; /* Safari */
        button.style.display = 'flex';
        button.style.webkitAlignItems = 'center'; /* Safari */
        button.style.alignItems = 'center';
        button.style.webkitJustifyContent = 'center'; /* Safari */
        button.style.justifyContent = 'center';
        button.onclick = () => {
            messageInput.value += emoji;
            messageInput.focus();
        };
        const wrapper = document.createElement('div');
        wrapper.style.padding = '2px';
        wrapper.appendChild(button);
        emojiGrid.appendChild(wrapper);
    });

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —ç–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä–∞
    let isEmojiPickerVisible = false;

    emojiButton.addEventListener('click', function(e) {
        e.stopPropagation();
        // –ü–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∏–∫–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        const buttonRect = emojiButton.getBoundingClientRect();
        const inputGroupRect = messageInput.parentElement.getBoundingClientRect();

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∏–∫–µ—Ä –Ω–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—è –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
        emojiPicker.style.position = 'fixed';
        emojiPicker.style.bottom = (window.innerHeight - inputGroupRect.top + 10) + 'px';
        emojiPicker.style.right = (window.innerWidth - buttonRect.right) + 'px';

        emojiPicker.style.display = isEmojiPickerVisible ? 'none' : 'block';
        isEmojiPickerVisible = !isEmojiPickerVisible;
    });

    // –°–∫—Ä—ã—Ç–∏–µ –ø–∏–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
            emojiPicker.style.display = 'none';
            isEmojiPickerVisible = false;
        }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –ø–∏–∫–µ—Ä–∞
    emojiPicker.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', function() {
        if (isEmojiPickerVisible) {
            const buttonRect = emojiButton.getBoundingClientRect();
            const inputGroupRect = messageInput.parentElement.getBoundingClientRect();

            emojiPicker.style.bottom = (window.innerHeight - inputGroupRect.top + 10) + 'px';
            emojiPicker.style.right = (window.innerWidth - buttonRect.right) + 'px';
        }
    });
</script>
{% endblock %}