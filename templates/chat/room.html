{% extends 'base.html' %}

{% load static %}

{% block title %}Ğ§Ğ°Ñ‚: {{ display_name }}{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h1>ğŸ’¬ {{ display_name }}</h1>
        <p class="chat-description">{{ room.topic|default:"ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚" }}</p>
    </div>

    <div id="chat-messages" class="chat-messages">
        {% for message in messages %}
            <div class="message {% if message.user.username == user.username %}my-message{% endif %}">
                <div class="message-header">
                    <strong>{{ message.user.username }}</strong>
                    <span class="message-time">{{ message.created_at|date:"H:i" }}</span>
                </div>
                <div class="message-content">{{ message.content }}</div>
            </div>
        {% empty %}
            <div class="no-messages">
                <p>ğŸ“­ ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹. ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ!</p>
            </div>
        {% endfor %}
    </div>

    <!-- âœ… Ğ¤ĞĞ ĞœĞ Ğ¡ EMOJI ĞšĞĞĞŸĞšĞĞ™ -->
    <form id="message-form" class="message-form">
        <button type="button" class="btn-emoji" id="emoji-button" title="Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸">
            ğŸ˜Š
        </button>
        <input 
            type="text" 
            id="chat-message-input" 
            placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." 
            maxlength="1000"
            autocomplete="off"
        >
        <button type="submit" id="chat-message-submit" class="btn-send">
            <span>ğŸ“¤</span>
            ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ
        </button>
    </form>

    <!-- âœ… ĞŸĞĞĞ•Ğ›Ğ¬ EMOJI -->
    <div id="emoji-picker" class="emoji-picker">
        <div class="emoji-grid">
            <span class="emoji-item">ğŸ˜€</span><span class="emoji-item">ğŸ˜ƒ</span><span class="emoji-item">ğŸ˜„</span><span class="emoji-item">ğŸ˜</span>
            <span class="emoji-item">ğŸ˜…</span><span class="emoji-item">ğŸ˜‚</span><span class="emoji-item">ğŸ¤£</span><span class="emoji-item">ğŸ˜Š</span>
            <span class="emoji-item">ğŸ˜‡</span><span class="emoji-item">ğŸ™‚</span><span class="emoji-item">ğŸ˜‰</span><span class="emoji-item">ğŸ˜Œ</span>
            <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¥°</span><span class="emoji-item">ğŸ˜˜</span><span class="emoji-item">ğŸ˜—</span>
            <span class="emoji-item">ğŸ˜™</span><span class="emoji-item">ğŸ˜š</span><span class="emoji-item">ğŸ˜‹</span><span class="emoji-item">ğŸ˜›</span>
            <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜œ</span><span class="emoji-item">ğŸ¤ª</span><span class="emoji-item">ğŸ¤¨</span>
            <span class="emoji-item">ğŸ§</span><span class="emoji-item">ğŸ¤“</span><span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¤©</span>
            <span class="emoji-item">ğŸ¥³</span><span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜’</span><span class="emoji-item">ğŸ˜</span>
            <span class="emoji-item">ğŸ˜”</span><span class="emoji-item">ğŸ˜Ÿ</span><span class="emoji-item">ğŸ˜•</span><span class="emoji-item">ğŸ™</span>
            <span class="emoji-item">â˜¹ï¸</span><span class="emoji-item">ğŸ˜£</span><span class="emoji-item">ğŸ˜–</span><span class="emoji-item">ğŸ˜«</span>
            <span class="emoji-item">ğŸ˜©</span><span class="emoji-item">ğŸ¥º</span><span class="emoji-item">ğŸ˜¢</span><span class="emoji-item">ğŸ˜­</span>
            <span class="emoji-item">ğŸ˜¤</span><span class="emoji-item">ğŸ˜ </span><span class="emoji-item">ğŸ˜¡</span><span class="emoji-item">ğŸ¤¬</span>
            <span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ‘Œ</span><span class="emoji-item">âœŒï¸</span>
            <span class="emoji-item">ğŸ¤</span><span class="emoji-item">ğŸ¤Ÿ</span><span class="emoji-item">ğŸ¤˜</span><span class="emoji-item">ğŸ¤™</span>
            <span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ™Œ</span><span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ¤</span>
            <span class="emoji-item">ğŸ™</span><span class="emoji-item">ğŸ’ª</span><span class="emoji-item">ğŸ¦¾</span><span class="emoji-item">ğŸ¦¿</span>
            <span class="emoji-item">â¤ï¸</span><span class="emoji-item">ğŸ§¡</span><span class="emoji-item">ğŸ’›</span><span class="emoji-item">ğŸ’š</span>
            <span class="emoji-item">ğŸ’™</span><span class="emoji-item">ğŸ’œ</span><span class="emoji-item">ğŸ–¤</span><span class="emoji-item">ğŸ¤</span>
            <span class="emoji-item">ğŸ’¯</span><span class="emoji-item">ğŸ”¥</span><span class="emoji-item">â­</span><span class="emoji-item">âœ¨</span>
            <span class="emoji-item">ğŸ‰</span><span class="emoji-item">ğŸŠ</span><span class="emoji-item">ğŸˆ</span><span class="emoji-item">ğŸ</span>
        </div>
    </div>
</div>

<style>
.chat-container {
    max-width: 1000px;
    margin: 40px auto;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    position: relative;
}

.chat-header {
    text-align: center;
    color: white;
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(10px);
}

.chat-header h1 {
    margin: 0;
    font-size: 2em;
    font-weight: 700;
}

.chat-description {
    margin: 10px 0 0 0;
    opacity: 0.9;
    font-size: 1.1em;
}

.chat-messages {
    height: 500px;
    overflow-y: auto;
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    scroll-behavior: smooth;
}

.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

.message {
    margin-bottom: 15px;
    padding: 12px 16px;
    border-radius: 12px;
    background: #f8f9fa;
    max-width: 70%;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.my-message {
    margin-left: auto;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 0.9em;
}

.message.my-message .message-header {
    color: rgba(255, 255, 255, 0.9);
}

.message-time {
    opacity: 0.7;
    font-size: 0.85em;
}

.message-content {
    word-wrap: break-word;
    line-height: 1.5;
}

.no-messages {
    text-align: center;
    color: #999;
    padding: 60px 20px;
}

.no-messages p {
    font-size: 1.2em;
    margin: 0;
}

/* âœ… Ğ¤ĞĞ ĞœĞ Ğ¡ EMOJI */
.message-form {
    display: flex;
    gap: 10px;
    position: relative;
}

.btn-emoji {
    padding: 15px 20px;
    background: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    font-size: 1.5em;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-emoji:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}

#chat-message-input {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    font-size: 1em;
    background: rgba(255, 255, 255, 0.95);
    transition: all 0.3s ease;
}

#chat-message-input:focus {
    outline: none;
    border-color: white;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    background: white;
}

.btn-send {
    padding: 15px 30px;
    background: white;
    color: #667eea;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-size: 1em;
}

.btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 255, 255, 0.3);
}

.btn-send:active {
    transform: translateY(0);
}

/* âœ… EMOJI PICKER */
.emoji-picker {
    display: none;
    position: absolute;
    bottom: 70px;
    left: 0;
    background: white;
    border-radius: 15px;
    padding: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    max-width: 350px;
    animation: emojiSlideUp 0.3s ease-out;
}

@keyframes emojiSlideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
}

.emoji-grid::-webkit-scrollbar {
    width: 6px;
}

.emoji-grid::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 10px;
}

.emoji-item {
    font-size: 1.8em;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    text-align: center;
}

.emoji-item:hover {
    background: #f0f0f0;
    transform: scale(1.2);
}

/* âœ… Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯ ĞœĞĞ”Ğ•Ğ ĞĞ¦Ğ˜Ğ˜ */
.moderation-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 10000;
    max-width: 350px;
}

.moderation-notification.show {
    opacity: 1;
    transform: translateX(0);
}

.moderation-icon {
    font-size: 24px;
    animation: shake 0.5s ease-in-out;
}

.moderation-text {
    font-weight: 500;
    font-size: 14px;
    line-height: 1.4;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@media (max-width: 768px) {
    .chat-container {
        margin: 20px;
        padding: 15px;
    }

    .chat-messages {
        height: 400px;
    }

    .message {
        max-width: 85%;
    }

    .message-form {
        flex-wrap: wrap;
    }

    .btn-emoji {
        order: 1;
    }

    #chat-message-input {
        order: 2;
        width: calc(100% - 70px);
    }

    .btn-send {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
    }

    .emoji-picker {
        left: 0;
        right: 0;
        max-width: none;
        bottom: 130px;
    }

    .emoji-grid {
        grid-template-columns: repeat(6, 1fr);
    }

    .moderation-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
    }
}
</style>

<script>
    const roomName = "{{ room_name }}";
    const currentUsername = "{{ user.username }}";
    const chatMessages = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    let isEmojiPickerVisible = false;

    // WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onopen = function(e) {
        console.log('âœ… WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
        if (data.error || data.moderation_blocked) {
            showModerationError(data.error || 'Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
            return;
        }

        // ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');

        if (data.username === currentUsername) {
            messageDiv.classList.add('my-message');
        }

        messageDiv.innerHTML = `
            <div class="message-header">
                <strong>${escapeHtml(data.username)}</strong>
                <span class="message-time">${data.timestamp}</span>
            </div>
            <div class="message-content">${escapeHtml(data.message)}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('âŒ WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾');
    };

    chatSocket.onerror = function(error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° WebSocket:', error);
    };

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const message = messageInput.value.trim();

        if (message === '') {
            return;
        }

        chatSocket.send(JSON.stringify({
            'message': message
        }));

        messageInput.value = '';
        messageInput.focus();
    });

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Enter
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitButton.click();
        }
    });

    // âœ… EMOJI PICKER
    emojiButton.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.style.display = isEmojiPickerVisible ? 'none' : 'block';
        isEmojiPickerVisible = !isEmojiPickerVisible;
    });

    // Ğ’ÑÑ‚Ğ°Ğ²ĞºĞ° emoji Ğ² Ğ¿Ğ¾Ğ»Ğµ
    document.querySelectorAll('.emoji-item').forEach(emoji => {
        emoji.addEventListener('click', function() {
            messageInput.value += this.textContent;
            messageInput.focus();
        });
    });

    // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ picker Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ ĞµĞ³Ğ¾
    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
            emojiPicker.style.display = 'none';
            isEmojiPickerVisible = false;
        }
    });

    // âœ… Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
    function showModerationError(errorMessage) {
        const notification = document.createElement('div');
        notification.className = 'moderation-notification';
        notification.innerHTML = `
            <div class="moderation-icon">âš ï¸</div>
            <div class="moderation-text">${escapeHtml(errorMessage)}</div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 10);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // ĞĞ²Ñ‚Ğ¾Ñ„Ğ¾ĞºÑƒÑ
    messageInput.focus();
    chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}
