{% extends 'base.html' %}
{% load static %}

{% block title %}Ğ§Ğ°Ñ‚: {{ display_name }}{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-card">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-comments fa-2x text-white me-3"></i>
                <div>
                    <h5 class="mb-0">{{ display_name }}</h5>
                    <small class="text-white-50">
                        <i class="fas fa-circle text-success me-1" style="font-size: 0.6rem;"></i>
                        ĞĞ½Ğ»Ğ°Ğ¹Ğ½
                    </small>
                </div>
            </div>
            <a href="{% url 'blog:home' %}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>ĞĞ°Ğ·Ğ°Ğ´
            </a>
        </div>

        <div class="chat-body">
            <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° -->
            <div class="chat-search">
                <form method="get" action="{% url 'blog:chat_room' room_name %}">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" name="q" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼..." value="{{ search_query }}">
                        <button class="btn btn-primary" type="submit">ĞĞ°Ğ¹Ñ‚Ğ¸</button>
                    </div>
                </form>
            </div>

            <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
            <div class="chat-messages" id="chat-messages" data-room-name="{{ room_name }}">
                {% for message in messages %}
                <div class="message-item {% if message.user_username == user.username %}message-own{% endif %}">
                    <div class="message-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong class="message-username">{{ message.user_username }}</strong>
                            <small class="message-time">{{ message.created_at|date:"d.m.Y H:i" }}</small>
                        </div>
                        <p class="message-text">{{ message.content }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- ĞŸĞ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ -->
            {% if messages.has_other_pages %}
            <nav class="chat-pagination">
                <ul class="pagination pagination-sm justify-content-center mb-3">
                    {% if messages.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ messages.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in messages.paginator.page_range %}
                        {% if num == messages.number %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > messages.number|add:'-3' and num < messages.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if messages.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ messages.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ messages.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ²Ğ²Ğ¾Ğ´Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
            <div class="chat-input">
                <form id="message-form" class="d-flex gap-2">
                    <button type="button" class="btn btn-emoji" id="emoji-button" title="Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸">
                        <i class="fas fa-smile"></i>
                    </button>
                    <input type="text" id="message-input" class="form-control" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." autocomplete="off" maxlength="500">
                    <button type="submit" class="btn btn-primary btn-send">
                        <i class="fas fa-paper-plane me-1"></i>ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                    </button>
                </form>

                <!-- ĞŸĞ¸ĞºĞµÑ€ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ -->
                <div id="emoji-picker" class="emoji-picker">
                    <div class="emoji-grid">
                        <span class="emoji-item">ğŸ˜€</span><span class="emoji-item">ğŸ˜ƒ</span><span class="emoji-item">ğŸ˜„</span><span class="emoji-item">ğŸ˜</span>
                        <span class="emoji-item">ğŸ˜…</span><span class="emoji-item">ğŸ˜‚</span><span class="emoji-item">ğŸ¤£</span><span class="emoji-item">ğŸ˜Š</span>
                        <span class="emoji-item">ğŸ˜‡</span><span class="emoji-item">ğŸ™‚</span><span class="emoji-item">ğŸ˜‰</span><span class="emoji-item">ğŸ˜Œ</span>
                        <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¥°</span><span class="emoji-item">ğŸ˜˜</span><span class="emoji-item">ğŸ˜—</span>
                        <span class="emoji-item">ğŸ˜™</span><span class="emoji-item">ğŸ˜š</span><span class="emoji-item">ğŸ˜‹</span><span class="emoji-item">ğŸ˜›</span>
                        <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜œ</span><span class="emoji-item">ğŸ¤ª</span><span class="emoji-item">ğŸ¤¨</span>
                        <span class="emoji-item">ğŸ§</span><span class="emoji-item">ğŸ¤“</span><span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¤©</span>
                        <span class="emoji-item">ğŸ¥³</span><span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜’</span><span class="emoji-item">ğŸ˜</span>
                        <span class="emoji-item">ğŸ˜”</span><span class="emoji-item">ğŸ˜Ÿ</span><span class="emoji-item">ğŸ˜•</span><span class="emoji-item">ğŸ˜£</span>
                        <span class="emoji-item">ğŸ˜–</span><span class="emoji-item">ğŸ˜«</span><span class="emoji-item">ğŸ˜©</span><span class="emoji-item">ğŸ¥º</span>
                        <span class="emoji-item">ğŸ˜¢</span><span class="emoji-item">ğŸ˜­</span><span class="emoji-item">ğŸ˜¤</span><span class="emoji-item">ğŸ˜ </span>
                        <span class="emoji-item">ğŸ˜¡</span><span class="emoji-item">ğŸ¤¬</span><span class="emoji-item">ğŸ¤¯</span><span class="emoji-item">ğŸ˜³</span>
                        <span class="emoji-item">ğŸ¥µ</span><span class="emoji-item">ğŸ¥¶</span><span class="emoji-item">ğŸ˜±</span><span class="emoji-item">ğŸ˜¨</span>
                        <span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ™Œ</span>
                        <span class="emoji-item">ğŸ¤</span><span class="emoji-item">ğŸ™</span><span class="emoji-item">â¤ï¸</span><span class="emoji-item">ğŸ’”</span>
                        <span class="emoji-item">ğŸ’¯</span><span class="emoji-item">âœ¨</span><span class="emoji-item">ğŸ”¥</span><span class="emoji-item">âš¡</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const roomName = "{{ room_name }}";
    const currentUsername = "{{ user.username }}";
    const chatMessages = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    let isEmojiPickerVisible = false;

    // WebSocket Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const chatSocket = new WebSocket(
        protocol + '//' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // ĞŸÑ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ° Ğ²Ğ½Ğ¸Ğ·
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const isOwnMessage = data.username === currentUsername;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-item animate-slide-right' + (isOwnMessage ? ' message-own' : '');
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <strong class="message-username">${data.username}</strong>
                    <small class="message-time">${new Date().toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</small>
                </div>
                <p class="message-text">${data.message}</p>
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚:', e);
    };

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    messageForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();

        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    };

    // Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¿Ğ¸ĞºĞµÑ€
    emojiButton.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.style.display = isEmojiPickerVisible ? 'none' : 'block';
        isEmojiPickerVisible = !isEmojiPickerVisible;
    });

    document.querySelectorAll('.emoji-item').forEach(emoji => {
        emoji.addEventListener('click', function() {
            messageInput.value += this.textContent;
            messageInput.focus();
        });
    });

    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
            emojiPicker.style.display = 'none';
            isEmojiPickerVisible = false;
        }
    });

    emojiPicker.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // ĞĞ²Ñ‚Ğ¾Ñ„Ğ¾ĞºÑƒÑ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
    messageInput.focus();

    // ĞŸÑ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
    scrollToBottom();
</script>
{% endblock %}