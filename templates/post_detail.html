{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="post-detail-container">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
        <div class="col-lg-10 mx-auto">
            <article class="post-detail-card">
                {% if post.image %}
                <div class="post-detail-image">
                    <img src="{{ post.image.url }}" alt="{{ post.title }}">
                </div>
                {% endif %}

                <div class="post-detail-content">
                    <h1 class="post-detail-title">{{ post.title }}</h1>

                    <div class="post-meta-bar">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>{{ post.author.email }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{ post.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                        {% if post.updated_at and post.updated_at != post.created_at %}
                        <div class="meta-item">
                            <i class="fas fa-edit"></i>
                            <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ post.updated_at|date:"d.m.Y H:i" }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            {% if post.is_published %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle me-1"></i>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
                                </span>
                            {% else %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-clock me-1"></i>–ß–µ—Ä–Ω–æ–≤–∏–∫
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="post-detail-text">
                        {% if post.is_published %}
                            {{ post.content|linebreaks }}
                        {% else %}
                            <div class="restricted-content">
                                <i class="fas fa-lock fa-3x mb-3"></i>
                                <p>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏.</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- –†–µ–∞–∫—Ü–∏–∏ -->
                    {% if user.is_authenticated %}
                    <div class="reactions-section" id="reactions-section">
                        <h6 class="reactions-title">
                            <i class="fas fa-heart me-2"></i>–í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è
                        </h6>
                        <div class="reactions-buttons">
                            <!-- ‚úÖ AJAX –∫–Ω–æ–ø–∫–∏ -->
                            <button type="button" 
                                    class="btn-reaction btn-like {% if user_reaction == 'like' %}active{% endif %}" 
                                    data-reaction="like"
                                    onclick="toggleReaction('like')">
                                <span class="reaction-icon">üëç</span>
                                <span class="reaction-count" id="like-count">{{ like_count }}</span>
                            </button>

                            <button type="button" 
                                    class="btn-reaction btn-dislike {% if user_reaction == 'dislike' %}active{% endif %}" 
                                    data-reaction="dislike"
                                    onclick="toggleReaction('dislike')">
                                <span class="reaction-icon">üëé</span>
                                <span class="reaction-count" id="dislike-count">{{ dislike_count }}</span>
                            </button>

                            <a href="{% url 'blog:chat_room' post.slug|default:'general' %}" class="btn-reaction btn-discuss">
                                <span class="reaction-icon">üí¨</span>
                                <span>–û–±—Å—É–¥–∏—Ç—å</span>
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ -->
                    {% if user.is_staff or user.is_superuser %}
                    <div class="admin-actions">
                        <h6 class="admin-title">
                            <i class="fas fa-cog me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                        </h6>
                        <div class="admin-buttons">
                            <a href="{% url 'blog:post_edit' post.pk %}" class="btn-admin btn-edit">
                                <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'blog:post_delete' post.pk %}" class="btn-admin btn-delete">
                                <i class="fas fa-trash-alt me-2"></i>–£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </article>

            <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
            <div class="back-button-section">
                <a href="{% url 'blog:home' %}" class="btn-back">
                    <i class="fas fa-arrow-left me-2"></i>
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô AJAX —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º CSRF -->
<script>
    const postId = {{ post.pk }};
    let currentReaction = '{{ user_reaction }}' || null;

    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCookie('csrftoken');

    function toggleReaction(reactionType) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫ —Å—Ä–∞–∑—É
        const likeBtn = document.querySelector('.btn-like');
        const dislikeBtn = document.querySelector('.btn-dislike');

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞
        const formData = new FormData();
        formData.append('reaction_type', reactionType);
        formData.append('csrfmiddlewaretoken', csrfToken);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
        fetch(`/toggle-reaction/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('like-count').textContent = data.like_count;
                document.getElementById('dislike-count').textContent = data.dislike_count;

                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');

                if (data.user_reaction === 'like') {
                    likeBtn.classList.add('active');
                    currentReaction = 'like';
                } else if (data.user_reaction === 'dislike') {
                    dislikeBtn.classList.add('active');
                    currentReaction = 'dislike';
                } else {
                    currentReaction = null;
                }

                // ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
                const clickedBtn = reactionType === 'like' ? likeBtn : dislikeBtn;
                clickedBtn.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    clickedBtn.style.transform = 'scale(1)';
                }, 200);

                // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                console.log(data.message);

            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∞–∫—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        });
    }

    // ‚úÖ –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.btn-reaction').forEach(btn => {
        btn.style.transition = 'all 0.2s ease';
    });
</script>
{% endblock %}
