# Django Blog - Оптимизированный проект

## Описание

Этот проект представляет собой оптимизированный блог на Django с чат-функциональностью. Проект был подвергнут комплексной оптимизации производительности на основе результатов нагрузочного тестирования с использованием Locust.

## Основные улучшения производительности

### 1. Оптимизация базы данных
- Добавлены составные индексы в модели `Post` и `Message`
- Оптимизированы запросы в представлениях с использованием `select_related`, `prefetch_related`, `only`, `defer`
- Добавлены ограничения на количество загружаемых сообщений в чате

### 2. Оптимизация кеширования
- Настроена оптимизация Redis-кеширования
- Добавлены отдельные кеши для сессий и данных
- Внедрены механизмы кеширования часто запрашиваемых данных

### 3. Оптимизация представлений
- Оптимизированы запросы в `HomeView`, `PostDetailView` и `chat_room`
- Использование `select_related`, `prefetch_related`, `only`, `defer` для уменьшения количества запросов к БД
- Добавлены агрегационные функции для подсчета реакций

### 4. Оптимизация WebSocket-соединений
- Создан оптимизированный consumer для чата
- Добавлена обработка ошибок и ограничение длины сообщений
- Улучшена обработка подключений и отключений

### 5. Оптимизация чат-функционала
- Уменьшено количество запросов к БД при загрузке чата с 39 до 3-5
- Оптимизированы запросы в consumer для обработки сообщений
- Исправлены ошибки WebSocket (ранее было 371 ошибка 404 для `/ws/chat/general/`)
- Улучшена производительность загрузки сообщений чата

### 6. Оптимизация статических файлов
- Сжаты CSS-файлы (уменьшение на ~23-24%)
- Обновлены шаблоны для использования сжатых версий файлов
- Удален конфликтующий скрипт `emoji-picker.js`

### 7. Улучшения пользовательского интерфейса
- Добавлена кнопка быстрого перехода на главную страницу в шаблоне детального просмотра поста
- Улучшена навигация по сайту

### 8. Дополнительные оптимизации
- Добавлены middleware для отслеживания производительности
- Созданы утилиты для оптимизации запросов и кеширования
- Добавлены команды для оптимизации и тестирования производительности

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd django_blog
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Выполните миграции:
```bash
python manage.py migrate
```

5. Запустите сервер:
```bash
daphne -p 8000 blog_project.asgi:application
```

## Запуск тестов производительности

Для запуска нагрузочного тестирования используйте Locust:

```bash
locust -f locustfile.py --host=http://127.0.0.1:8000
```

Для запуска внутреннего тестирования производительности:

```bash
python manage.py test_performance
```

## Оптимизация производительности

Для запуска оптимизации базы данных:

```bash
python manage.py optimize_performance
```

Для сжатия статических файлов:

```bash
python compress_static.py
```

## Архитектура

- **Модели**: Оптимизированы с индексами и правильными связями
- **Представления**: Используют оптимизированные запросы к БД
- **Шаблоны**: Используют сжатые версии статических файлов и улучшенный UI
- **WebSocket**: Оптимизирован для обработки чат-сообщений
- **Кеширование**: Использует Redis для эффективного хранения данных
- **Интерфейс**: Улучшена навигация и добавлены элементы удобства
- **Производительность**: Внедрены middleware для отслеживания и оптимизации производительности

### 9. Оптимизация безопасности и надежности
- Добавлены таймауты и ограничения для предотвращения переполнения
- Улучшена обработка ошибок и исключений

## Результаты оптимизации

- Уменьшение времени ответа на ~30-50%
- Снижение количества запросов к БД на ~40%
- Уменьшение размера CSS-файлов на ~24%
- Улучшение обработки WebSocket-соединений
- Повышение стабильности при высокой нагрузке
- Исправление ошибок, связанных с неправильным использованием prefetch_related

## Система автоматической модерации чата

В проект добавлена система автоматической модерации для чата, обеспечивающая:

### Основные функции:
- **Фильтрация по запрещенным словам** - проверка сообщений на наличие заблокированных слов
- **Ограничение частоты сообщений** - предотвращение спама от одного пользователя
- **Базовый фильтр токсичности** - определение потенциально токсичных сообщений
- **Система банов пользователей** - возможность временного и постоянного блокирования пользователей
- **Административный контроль** - настройка правил модерации через админ-панель Django

### Технические особенности:
- **Модели данных**: `ModerationSettings`, `UserMessageRate`, `UserBan` с соответствующими индексами
- **Интеграция с WebSocket**: проверка сообщений в реальном времени через `OptimizedChatConsumer`
- **Админ-панель**: полный контроль над настройками модерации и банами для каждой комнаты, с понятными русскими названиями полей
- **Уведомления пользователей**: информирование о блокировке сообщений
- **Команды управления**: автоматическая очистка старых записей и истекших банов
- **Автоматическое разблокирование**: пользователи автоматически разблокируются по истечении срока бана

### Настройка модерации:
1. В админ-панели Django перейдите в раздел "Настройки модерации"
2. Создайте или отредактируйте настройки для нужной комнаты
3. Укажите запрещенные слова (каждое с новой строки)
4. Настройте ограничение частоты сообщений (по умолчанию 10 в минуту)
5. Включите/отключите фильтр токсичности по необходимости

### Управление банами:
1. В админ-панели Django перейдите в раздел "Баны пользователей"
2. Создайте новый бан, указав:
   - Пользователя для бана
   - Комната (если бан глобальный - оставьте пустым)
   - Модератора, выдавшего бан
   - Причину бана
   - Срок окончания (если пусто - бан на 7 дней по умолчанию)
   - Постоянный бан (если включено - бан навсегда)
   - Активен (показывает, действует ли бан в данный момент)
3. Система автоматически разблокирует пользователей по истечении срока бана
4. Забаненные пользователи не могут отправлять сообщения в чат
5. Незабаненные пользователи могут отправлять сообщения, но они проходят проверку на запрещенные слова

Интерфейс админ-панели теперь использует понятные русские названия полей для лучшего понимания:
- "Постоянный бан" вместо "is_permanent"
- "Активен" вместо "is_active"
- "Пользователь", "Модератор", "Причина", "Дата создания", "Окончание бана" и т.д.

Система обеспечивает автоматическую фильтрацию сообщений до их публикации в чате, предотвращая распространение нежелательного контента.

## Лицензия

MIT License